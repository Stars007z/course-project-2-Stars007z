# ADR-002: Rate Limiting на `/vote` с привязкой к аутентифицированному пользователю

Дата: 2025-10-22
Статус: Accepted

## Context
Сервис использует `slowapi` для глобального rate limiting по IP-адресу. Однако:
- IP-based лимит неэффективен против атак с прокси или ботнетов,
- легитимные пользователи за NAT (офис, школа) могут страдать от ложных срабатываний,
- NFR-08 требует **ограничение в 5 запросов/мин на одного пользователя** (а не на IP).

## Decision
Настроить `slowapi` так, чтобы лимит на эндпоинте `/features/{id}/vote` применялся **по `user_id`**, а не по IP.

Для этого:
- реализуем кастомную `key_func`, которая возвращает `str(current_user.id)` для аутентифицированных запросов,
- применяем декоратор `@limiter.limit("5/minute", key_func=user_id_key_func)` только к `/vote`.

Такой подход:
- использует уже подключенный и протестированный `slowapi`,
- не требует Redis или кастомного кэша,
- работает корректно в тестах и продакшене.

## Consequences
+ Соответствует NFR-08: лимит привязан к пользователю, а не к IP.
+ Защищает от flood-атак (R1), даже если злоумышленник меняет IP.
+ Не блокирует легитимных пользователей за NAT.
+ Минимальные изменения в коде — только кастомная `key_func`.

– Требует, чтобы запрос был аутентифицирован (но `/vote` и так требует токен → OK).

## Alternatives
1. **Оставить IP-based лимит** — нарушает NFR-08 и уязвим к обходу.
2. **Реализовать in-memory TTL-кэш** — избыточно, не масштабируется, дублирует функционал `slowapi`.
3. **Использовать Redis** — надёжно, но избыточно для P05 и требует инфраструктуры.

Выбрали **кастомную `key_func` для `slowapi`** как простое, безопасное и соответствующее стеку решение.

## Security Impact
Полностью закрывает риск **R1** (брутфорс/флуд голосований), так как лимит теперь привязан к учётной записи, а не к сети.

## Rollout Plan
- Реализовать `user_id_key_func(request: Request) -> str`.
- Применить `@limiter.limit("5/minute", key_func=user_id_key_func)` к `/features/{id}/vote`.
- Добавить e2e-тест: 6-й запрос за минуту → 429.

## Links
- NFR-08
- R1 из Risk Register
- STRIDE: DoS (F1)
- Тест: `tests/test_errors.py::test_rate_limit_exceeded`
