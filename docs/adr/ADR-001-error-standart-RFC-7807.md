# ADR-001: Стандартизация ошибок по RFC 7807

Дата: 2025-10-22
Статус: Accepted

## Context
Сервис возвращает ошибки в собственном формате, что:
- раскрывает внутренние детали (например, различие между "пользователь не найден" и "фича не найдена"),
- не соответствует NFR-03 ("Маскировка ошибок безопасности"),
- усложняет интеграцию клиентам.

## Decision
Все 4xx/5xx ошибки будут возвращаться в формате [RFC 7807](https://datatracker.ietf.org/doc/html/rfc7807):
- `type`: URI с кодом ошибки (например, `https://featurevotes.example.com/errors/duplicate_vote`)
- `title`: человекочитаемое краткое описание
- `status`: HTTP-статус
- `detail`: опциональное пояснение
- `correlation_id`: UUID для трассировки в логах

Реализуем обработчик `problem()` и заменим `ApiError` → `HTTPException` с кастомным `problem()`.

## Consequences
+ Безопасность: единый 404 для всех несуществующих ресурсов → защита от разведки (R11).
+ Стандартизация: клиенты могут обрабатывать ошибки единообразно.
– Нужно обновить все тесты на ошибки.

## Alternatives
1. **Оставить текущий формат** — проще, но нарушает NFR-03.
2. **Использовать только `detail` без `type/title`** — не соответствует RFC.
3. **Добавить `stack trace` в dev-режиме** — опасно, даже в dev.

Выбрали RFC 7807 как промышленный стандарт.

## Security Impact
Закрывает риски:
- R3 (утечка stack trace),
- R11 (разведка через 404).

## Rollout Plan
- Заменить `ApiError` на `HTTPException` с вызовом `problem()`.
- Обновить все тесты на ошибки.
- Убедиться, что в CI нет утечек деталей.

## Links
- NFR-03
- R3, R11 из Risk Register
- STRIDE: Information Disclosure (F3, F7)
- Тест: `tests/test_errors.py::test_rfc7807_format`
