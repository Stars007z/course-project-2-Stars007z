# ADR-003: Централизованная валидация всех входных данных через Pydantic

Дата: 2025-10-22
Статус: Accepted

## Context
Сервис принимает пользовательские данные через HTTP-запросы (регистрация, голосование, создание фич и т.д.).
Без строгой валидации возможны:
- инъекции (SQL, path traversal),
- переполнение памяти (слишком длинные строки),
- неожиданное поведение из-за некорректных типов,
- нарушение бизнес-логики (например, пустой email).

Это прямо нарушает **NFR-02**: «Все входные данные строго типизированы и валидны».

## Decision
Все входные данные будут проходить **строгую валидацию на уровне Pydantic-моделей**:
- ограничение длины строк (`title`, `description`, `full_name`, `password`, `email`);
- запрет пустых значений;
- использование `EmailStr` для email;
- отключение автоматического приведения типов (`strict=True` по необходимости);
- обновление конфигурации моделей до Pydantic V2 (`from_attributes` вместо `orm_mode`).

Конкретные ограничения:
- `email`: валидный email, ≤ 254 символа (RFC 5321);
- `full_name`: 1–100 символов;
- `title`: 1–100 символов;
- `description`: 1–1000 символов;
- `password`: 8–128 символов.

## Consequences
+ Безопасность: предотвращение DoS через длинные строки, защита от некорректных данных.
+ Согласованность: клиенты получают чёткие ошибки 422 при нарушении контракта.
+ Соответствие NFR-02 и STRIDE (Spoofing/Tampering).

– Нужно обновить все схемы и тесты.

## Alternatives
1. **Валидация только на уровне БД** — поздно, ошибка уже дошла до ORM.
2. **Ручная проверка в эндпоинтах** — дублирование, легко пропустить.
3. **Оставить как есть** — нарушает NFR и уязвим к атакам.

Выбрали Pydantic как стандартный, декларативный и надёжный способ.

## Security Impact
Закрывает риски:
- R5 (некорректные входные данные),
- R4 (SQL-инъекции — хотя ORM их блокирует, валидация — дополнительный слой),
- R12 (целостность данных).

## Rollout Plan
- Обновить все `BaseModel`-схемы с ограничениями.
- Заменить `orm_mode = True` → `from_attributes = True`.
- Добавить негативные тесты на длинные/пустые поля.

## Links
- NFR-02
- R5, R12 из Risk Register
- STRIDE: Spoofing, Tampering
- Тест: `tests/test_errors.py::test_invalid_input_rejected`
